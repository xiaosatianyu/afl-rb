#!/bin/bash


export CurDir=`pwd`
export AFLGO=$CurDir/../../../aflgo
export SUBJECT=$CurDir/libpng-1.6.15
export TMP_DIR=$CurDir/temp

export CC=$AFLGO/afl-clang-fast
export CXX=$AFLGO/afl-clang-fast++
export CFLAGS="-targets=$TMP_DIR/BBtargets.txt  -outdir=$TMP_DIR  -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps "
export CXXFLAGS="-targets=$TMP_DIR/BBtargets.txt  -outdir=$TMP_DIR  -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"


#重新将距离编译进去
export CC=$AFLGO/afl-clang-fast
export CXX=$AFLGO/afl-clang-fast++
export CFLAGS="$COPY_CFLAGS -distance=$TMP_DIR/distance.cfg.txt  "
export CXXFLAGS="$COPY_CXXFLAGS -distance=$TMP_DIR/distance.cfg.txt  "

# 重新生成不加asan的版本
cd $SUBJECT
make clean
./configure --disable-shared

#加asan
#AFL_DONT_OPTIMIZE=1  AFL_USE_ASAN=1 make -j8
#cp $SUBJECT/pngtest  $CurDir/pngtest-asan

#不加asan
AFL_DONT_OPTIMIZE=1  make -j8
cp $SUBJECT/pngtest  $CurDir/pngtest-no-asan

